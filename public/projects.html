<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - Github Notion Logger</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/commit-logger-favicon_1.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/commit-logger-favicon_2.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/commit-logger-favicon_3.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/commit-logger-favicon_3.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/commit-logger-favicon_3.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-links {
            background: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-link {
            display: inline-block;
            margin: 0 1rem;
            padding: 0.5rem 1rem;
            text-decoration: none;
            color: #667eea;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: #f0f2ff;
        }

        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .controls {
            background: white;
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 1200px;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.25rem;
            background: #f8f9fa;
            padding: 0.25rem;
            border-radius: 6px;
        }

        .view-toggle .btn {
            margin: 0;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .view-toggle .btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.25rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            background: #218838;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .btn.small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            white-space: nowrap;
        }

        .filter-group select, .filter-group input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 2.5rem;
            width: 250px;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            background: #e9ecef;
            color: #495057;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .projects-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .projects-bar {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 2rem 0;
        }

        .project-bar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1rem 1.5rem;
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 1rem;
            align-items: center;
            transition: transform 0.2s ease;
            border-left: 4px solid #667eea;
        }

        .project-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .project-bar.excellent {
            border-left-color: #28a745;
        }

        .project-bar.good {
            border-left-color: #17a2b8;
        }

        .project-bar.fair {
            border-left-color: #ffc107;
        }

        .project-bar.poor {
            border-left-color: #fd7e14;
        }

        .project-bar.critical {
            border-left-color: #dc3545;
        }

        .project-bar-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .project-bar-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .project-bar-category {
            background: #e9ecef;
            color: #495057;
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            width: fit-content;
        }

        .project-bar-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.8rem;
            color: #666;
        }

        .project-bar-progress {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 120px;
        }

        .project-bar-progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .project-bar-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .project-bar-progress-text {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }

        .project-bar-stats {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            text-align: center;
            min-width: 80px;
        }

        .project-bar-stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }

        .project-bar-stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-bar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .project-bar .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .project-card.excellent {
            border-left-color: #28a745;
        }

        .project-card.good {
            border-left-color: #17a2b8;
        }

        .project-card.fair {
            border-left-color: #ffc107;
        }

        .project-card.poor {
            border-left-color: #fd7e14;
        }

        .project-card.critical {
            border-left-color: #dc3545;
        }

        .project-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .project-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-category {
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .project-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .health-excellent {
            background: #d4edda;
            color: #155724;
        }

        .health-good {
            background: #cce5ff;
            color: #004085;
        }

        .health-fair {
            background: #fff3cd;
            color: #856404;
        }

        .health-poor {
            background: #ffeaa7;
            color: #d63031;
        }

        .health-critical {
            background: #f8d7da;
            color: #721c24;
        }

        .project-body {
            padding: 1.5rem;
        }

        .progress-section {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-label {
            font-weight: 500;
            color: #333;
        }

        .progress-percentage {
            font-weight: 600;
            color: #28a745;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-item {
            text-align: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-factors {
            margin-top: 1rem;
        }

        .risk-factors h4 {
            font-size: 0.9rem;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }

        .risk-list {
            list-style: none;
            padding: 0;
        }

        .risk-item {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 0.25rem 0;
            display: inline-block;
        }

        .project-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .activity-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .activity-recent {
            background: #d4edda;
            color: #155724;
        }

        .activity-moderate {
            background: #fff3cd;
            color: #856404;
        }

        .activity-stale {
            background: #ffeaa7;
            color: #d63031;
        }

        .activity-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* Status-specific styling for weekly planning statuses */
        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-planning {
            background: #cce5ff;
            color: #004085;
        }

        .status-idea {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-paused {
            background: #fff3cd;
            color: #856404;
        }

        .status-done {
            background: #28a745;
            color: #ffffff;
        }

        .status-released {
            background: #17a2b8;
            color: #ffffff;
        }

        .status-unknown {
            background: #6c757d;
            color: #ffffff;
        }

        .status-parking-lot {
            background: #fd7e14;
            color: #ffffff;
        }

        .status-abandoned {
            background: #dc3545;
            color: #ffffff;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                margin: 1rem;
                padding: 1rem;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .project-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .project-bar {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                text-align: center;
            }

            .project-bar-info {
                align-items: center;
            }

            .project-bar-stats {
                flex-direction: row;
                justify-content: space-around;
            }

            .project-bar-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Github Notion Logger</h1>
        <p>Project Management Dashboard</p>
    </div>
    
    <div class="nav-links">
        <a href="/" class="nav-link">üèÉ Activity View</a>
        <a href="/week" class="nav-link">üìÖ Weekly Planning</a>
        <a href="/projects" class="nav-link active">üìÅ Projects</a>
        <a href="/progress" class="nav-link">üìä Progress</a>
    </div>
    
    <div class="controls">
        <div class="controls-header">
            <h2 class="controls-title">Project Overview</h2>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="view-toggle">
                    <button id="card-view-btn" class="btn secondary active">üìã Card View</button>
                    <button id="bar-view-btn" class="btn secondary">üìä Bar View</button>
                </div>
                <div>
                    <button id="refresh-btn" class="btn">üîÑ Refresh</button>
                    <button id="clear-cache-btn" class="btn secondary">üóëÔ∏è Clear Cache</button>
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group search-box">
                <input type="text" id="search-input" placeholder="Search projects...">
            </div>
            <div class="filter-group">
                <label for="category-filter">Category:</label>
                <select id="category-filter">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="status-filter">Status:</label>
                <select id="status-filter">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="planning">Planning</option>
                    <option value="idea">Idea</option>
                    <option value="paused">Paused</option>
                    <option value="done">Done</option>
                    <option value="released">Released</option>
                    <option value="unknown">Unknown</option>
                    <option value="parking-lot">Parking Lot</option>
                    <option value="abandoned">Abandoned</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="health-filter">Health:</label>
                <select id="health-filter">
                    <option value="">All Health</option>
                    <option value="excellent">Excellent</option>
                    <option value="good">Good</option>
                    <option value="fair">Fair</option>
                    <option value="poor">Poor</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="activity-filter">Activity:</label>
                <select id="activity-filter">
                    <option value="">All Activity</option>
                    <option value="recent">Recent</option>
                    <option value="moderate">Moderate</option>
                    <option value="stale">Stale</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sort-filter">Sort by:</label>
                <select id="sort-filter">
                    <option value="lastActivity">Last Activity</option>
                    <option value="name">Name</option>
                    <option value="healthScore">Health Score</option>
                    <option value="progress">Progress</option>
                </select>
            </div>
        </div>
        
        <div class="status" id="status">Ready to load projects</div>
    </div>
    
    <div class="projects-container">
        <div id="loading" class="loading">
            <p>Loading projects...</p>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="projects-grid" class="projects-grid" style="display: none;"></div>
        
        <div id="empty-state" class="empty-state" style="display: none;">
            <h3>No Projects Found</h3>
            <p>No projects match your current filters. Try adjusting your search criteria.</p>
        </div>
        
        <div id="pagination" class="pagination" style="display: none;"></div>
    </div>
    
    <script>
        let projects = [];
        let filteredProjects = [];
        let currentPage = 1;
        let pageSize = 12;
        let totalPages = 1;
        let categories = [];
        let currentView = 'card'; // Default to card view
        
        // Load projects on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            loadCategories();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('refresh-btn').addEventListener('click', loadProjects);
            document.getElementById('clear-cache-btn').addEventListener('click', clearCache);
            document.getElementById('search-input').addEventListener('input', debounce(filterProjects, 300));
            document.getElementById('category-filter').addEventListener('change', filterProjects);
            document.getElementById('status-filter').addEventListener('change', filterProjects);
            document.getElementById('health-filter').addEventListener('change', filterProjects);
            document.getElementById('activity-filter').addEventListener('change', filterProjects);
            document.getElementById('sort-filter').addEventListener('change', filterProjects);
            document.getElementById('card-view-btn').addEventListener('click', () => switchView('card'));
            document.getElementById('bar-view-btn').addEventListener('click', () => switchView('bar'));
        }
        
        async function loadProjects() {
            try {
                showLoading(true);
                updateStatus('Loading projects...', '');
                
                // Load both API data and weekly planning data in parallel
                const [apiResponse, weeklyResponse] = await Promise.allSettled([
                    fetch('/api/v2/projects/overview'),
                    fetch('/api/weekly-planning')
                ]);
                
                let apiData = null;
                let weeklyData = null;
                
                // Process API response
                if (apiResponse.status === 'fulfilled') {
                    const apiResult = await apiResponse.value.json();
                    if (apiResult.success) {
                        apiData = apiResult.data;
                    }
                }
                
                // Process weekly planning response
                if (weeklyResponse.status === 'fulfilled') {
                    const weeklyResult = await weeklyResponse.value.json();
                    if (weeklyResult.success && weeklyResult.data) {
                        weeklyData = weeklyResult.data;
                    }
                }
                
                if (!apiData) {
                    throw new Error('Failed to load project data from API');
                }
                
                // Merge API data with weekly planning data
                projects = mergeProjectData(apiData, weeklyData);
                filteredProjects = [...projects];
                
                // Update category filter with project counts
                updateCategoryFilter();
                
                displayProjects();
                updateStatus(`Loaded ${projects.length} projects (merged with weekly planning data)`, 'success');
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(`Error loading projects: ${error.message}`);
                updateStatus('Failed to load projects', 'error');
            }
        }

        function mergeProjectData(apiData, weeklyData) {
            // Create a map of weekly planning data by project name for quick lookup
            const weeklyMap = new Map();
            if (weeklyData && weeklyData.projects) {
                weeklyData.projects.forEach(project => {
                    if (project.name) {
                        weeklyMap.set(project.name, project);
                    }
                });
            }
            
            // Merge API data with weekly planning data
            return apiData.map(apiProject => {
                const weeklyProject = weeklyMap.get(apiProject.name) || weeklyMap.get(apiProject.repository);
                
                if (weeklyProject) {
                    // Merge the data, prioritizing weekly planning for status and category
                    return {
                        ...apiProject, // Start with API data (health scores, progress, etc.)
                        status: weeklyProject.status || apiProject.status, // Weekly planning status takes priority
                        category: weeklyProject.category || apiProject.category, // Weekly planning category takes priority
                        // Keep any additional weekly planning data
                        head: weeklyProject.head,
                        heart: weeklyProject.heart,
                        // Update lastActivity if weekly planning has more recent data
                        lastActivity: weeklyProject.lastActivity || apiProject.lastActivity
                    };
                }
                
                // If no weekly planning data found, return API data as-is
                return apiProject;
            });
        }
        
        async function loadCategories() {
            try {
                // Load categories from weekly planning data
                const response = await fetch('/api/weekly-planning');
                const result = await response.json();
                
                if (result.success && result.data && result.data.categories) {
                    // Extract unique categories from weekly planning data
                    const categorySet = new Set();
                    result.data.categories.forEach(category => {
                        if (category) categorySet.add(category);
                    });
                    
                    // Also add categories from loaded projects if available
                    if (projects && projects.length > 0) {
                        projects.forEach(project => {
                            if (project.category) {
                                categorySet.add(project.category);
                            }
                        });
                    }
                    
                    categories = Array.from(categorySet).map(category => ({
                        name: category,
                        count: 0 // Will be calculated when projects are loaded
                    }));
                    
                    updateCategoryFilter();
                } else {
                    // Fallback to default categories if weekly planning data is not available
                    categories = [
                        { name: 'Writing & Story Tools', count: 0 },
                        { name: 'Infrastructure & Utilities', count: 0 },
                        { name: 'Avoros (Shared Fantasy/Game World)', count: 0 },
                        { name: 'Miscellaneous / Standalone', count: 0 }
                    ];
                    updateCategoryFilter();
                }
            } catch (error) {
                console.warn('Failed to load categories from weekly planning, using defaults:', error.message);
                // Fallback to default categories
                categories = [
                    { name: 'Writing & Story Tools', count: 0 },
                    { name: 'Infrastructure & Utilities', count: 0 },
                    { name: 'Avoros (Shared Fantasy/Game World)', count: 0 },
                    { name: 'Miscellaneous / Standalone', count: 0 }
                ];
                updateCategoryFilter();
            }
        }
        
        function updateCategoryFilter() {
            const filter = document.getElementById('category-filter');
            const currentValue = filter.value;
            
            // Calculate counts based on loaded projects
            const categoryCounts = {};
            projects.forEach(project => {
                if (project.category) {
                    categoryCounts[project.category] = (categoryCounts[project.category] || 0) + 1;
                }
            });
            
            filter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const count = categoryCounts[category.name] || 0;
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = `${category.name} (${count})`;
                if (category.name === currentValue) {
                    option.selected = true;
                }
                filter.appendChild(option);
            });
        }
        
        function filterProjects() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            const health = document.getElementById('health-filter').value;
            const activity = document.getElementById('activity-filter').value;
            const sortBy = document.getElementById('sort-filter').value;
            
            filteredProjects = projects.filter(project => {
                // Search filter
                if (searchTerm && !project.name.toLowerCase().includes(searchTerm) &&
                    !project.category.toLowerCase().includes(searchTerm) &&
                    !project.repository.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Category filter
                if (category && project.category !== category) {
                    return false;
                }
                
                // Status filter
                if (status && project.status !== status) {
                    return false;
                }
                
                // Health filter
                if (health && project.health.healthStatus !== health) {
                    return false;
                }
                
                // Activity filter
                if (activity && project.activityStatus !== activity) {
                    return false;
                }
                
                return true;
            });
            
            // Sort projects
            filteredProjects.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'healthScore':
                        return b.health.healthScore - a.health.healthScore;
                    case 'progress':
                        return b.progress - a.progress;
                    case 'lastActivity':
                    default:
                        if (!a.lastActivity && !b.lastActivity) return 0;
                        if (!a.lastActivity) return 1;
                        if (!b.lastActivity) return -1;
                        return new Date(b.lastActivity) - new Date(a.lastActivity);
                }
            });
            
            currentPage = 1;
            displayProjects();
        }
        
        function displayProjects() {
            const container = document.getElementById('projects-grid');
            const emptyState = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');
            
            if (filteredProjects.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                pagination.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            totalPages = Math.ceil(filteredProjects.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageProjects = filteredProjects.slice(startIndex, endIndex);
            
            // Generate projects based on current view
            if (currentView === 'bar') {
                container.innerHTML = `
                    <div class="projects-bar">
                        ${pageProjects.map(project => createProjectBar(project)).join('')}
                    </div>
                `;
                container.style.display = 'block';
            } else {
                container.innerHTML = pageProjects.map(project => createProjectCard(project)).join('');
                container.style.display = 'grid';
            }
            
            emptyState.style.display = 'none';
            
            // Show pagination if needed
            if (totalPages > 1) {
                displayPagination();
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
            }
        }
        
        function createProjectCard(project) {
            const healthClass = project.health.healthStatus || 'unknown';
            const activityClass = project.activityStatus || 'inactive';
            
            return `
                <div class="project-card ${healthClass}">
                    <div class="project-header">
                        <div class="project-title">
                            <span>${project.name}</span>
                            <span class="project-category">${project.category}</span>
                        </div>
                        <div class="project-meta">
                            <div class="meta-item">
                                <span>üìÅ</span>
                                <span>${project.repository}</span>
                            </div>
                            <div class="meta-item">
                                <span class="status-badge status-${project.status || 'unknown'}">${project.status || 'unknown'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="activity-status activity-${activityClass}">${activityClass}</span>
                            </div>
                        </div>
                        <div class="health-indicator health-${healthClass}">
                            <span>üè•</span>
                            <span>${project.health.healthScore}/100 - ${project.health.healthStatus}</span>
                        </div>
                    </div>
                    
                    <div class="project-body">
                        <div class="progress-section">
                            <div class="progress-header">
                                <span class="progress-label">Progress</span>
                                <span class="progress-percentage">${project.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress}%"></div>
                            </div>
                            <div class="progress-stats">
                                <span>${project.storiesCompleted}/${project.storiesTotal} stories</span>
                                <span>${project.tasksCompleted}/${project.tasksTotal} tasks</span>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">${project.totalCommits}</div>
                                <div class="stat-label">Commits</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${project.health.completionVelocity}</div>
                                <div class="stat-label">Velocity</div>
                            </div>
                            ${project.head && project.heart ? `
                                <div class="stat-item">
                                    <div class="stat-number">${project.head}/${project.heart}</div>
                                    <div class="stat-label">Head/Heart</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${project.health.riskFactors && project.health.riskFactors.length > 0 ? `
                            <div class="risk-factors">
                                <h4>‚ö†Ô∏è Risk Factors</h4>
                                <ul class="risk-list">
                                    ${project.health.riskFactors.map(risk => `<li class="risk-item">${risk}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="project-actions">
                            <button class="btn btn-small" onclick="viewProjectDetails('${project.name}')">
                                üìã Details
                            </button>
                            <button class="btn btn-small secondary" onclick="scanProject('${project.name}')">
                                üîç Scan
                            </button>
                            ${project.hasPrd ? '' : `
                                <button class="btn btn-small danger" onclick="linkPrd('${project.name}')">
                                    üìÑ Link PRD
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function createProjectBar(project) {
            const healthClass = project.health.healthStatus || 'unknown';
            const activityClass = project.activityStatus || 'inactive';
            
            return `
                <div class="project-bar ${healthClass}">
                    <div class="project-bar-info">
                        <div class="project-bar-name">${project.name}</div>
                        <div class="project-bar-category">${project.category}</div>
                        <div class="project-bar-meta">
                            <span>üìÅ ${project.repository}</span>
                            <span class="status-badge status-${project.status || 'unknown'}">${project.status || 'unknown'}</span>
                            <span class="activity-status activity-${activityClass}">${activityClass}</span>
                        </div>
                    </div>
                    <div class="project-bar-progress">
                        <div class="project-bar-progress-bar">
                            <div class="project-bar-progress-fill" style="width: ${project.progress}%"></div>
                        </div>
                        <div class="project-bar-progress-text">${project.progress}% Complete</div>
                    </div>
                    <div class="project-bar-stats">
                        <div class="project-bar-stat-value">${project.storiesCompleted}/${project.storiesTotal}</div>
                        <div class="project-bar-stat-label">Stories</div>
                    </div>
                    <div class="project-bar-stats">
                        <div class="project-bar-stat-value">${project.tasksCompleted}/${project.tasksTotal}</div>
                        <div class="project-bar-stat-label">Tasks</div>
                    </div>
                    ${project.head && project.heart ? `
                        <div class="project-bar-stats">
                            <div class="project-bar-stat-value">${project.head}/${project.heart}</div>
                            <div class="project-bar-stat-label">Head/Heart</div>
                        </div>
                    ` : ''}
                    <div class="project-bar-actions">
                        <button class="btn btn-sm" onclick="viewProjectDetails('${project.name}')">
                            üìã Details
                        </button>
                        <button class="btn btn-sm secondary" onclick="scanProject('${project.name}')">
                            üîç Scan
                        </button>
                        ${project.hasPrd ? '' : `
                            <button class="btn btn-sm danger" onclick="linkPrd('${project.name}')">
                                üìÑ Link PRD
                            </button>
                        `}
                    </div>
                </div>
            `;
        }
        
        function displayPagination() {
            const pagination = document.getElementById('pagination');
            let html = '';
            
            // Previous button
            html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>`;
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                html += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span>...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="current-page"' : ''}>${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span>...</span>`;
                }
                html += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;
            
            pagination.innerHTML = html;
        }
        
        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayProjects();
            }
        }

        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('card-view-btn').classList.toggle('active', view === 'card');
            document.getElementById('bar-view-btn').classList.toggle('active', view === 'bar');
            
            // Redisplay projects with new view
            displayProjects();
        }
        
        function viewProjectDetails(projectName) {
            // TODO: Implement project details modal or navigation
            alert(`View details for ${projectName}`);
        }
        
        function scanProject(projectName) {
            // TODO: Implement project scanning
            alert(`Scan project ${projectName}`);
        }
        
        function linkPrd(projectName) {
            // TODO: Implement PRD linking
            alert(`Link PRD for ${projectName}`);
        }
        
        async function clearCache() {
            try {
                if (!confirm('Are you sure you want to clear the cache? This will refresh all project data.')) {
                    return;
                }
                
                updateStatus('Clearing cache...', '');
                
                const response = await fetch('/api/v2/cache/projects/clear', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('Cache cleared successfully', 'success');
                    loadProjects();
                } else {
                    throw new Error(result.error || 'Failed to clear cache');
                }
            } catch (error) {
                updateStatus(`Failed to clear cache: ${error.message}`, 'error');
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('projects-grid').style.display = show ? 'none' : 'grid';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
